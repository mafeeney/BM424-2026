```{r BM940path}
#| label: setup-patients
#| include: false

library(randomNames)
library(dplyr)

# ============================================================
# Define variables needed for generating patient data
# ============================================================

# ----------------------------------------------------------------
# NEW: Syndrome-based symptom model (novel pandemic)
# Instead of respiratory vs non-respiratory,
# patients express 1â€“2 syndrome profiles.
# ----------------------------------------------------------------

syndrome_profiles <- list(

  systemic = c(
    "persistent fever",
    "fatigue",
    "muscle aches",
    "loss of appetite",
    "night sweats"
  ),

  gastrointestinal = c(
    "nausea",
    "diarrhoea",
    "abdominal pain",
    "vomiting"
  ),

  neurological = c(
    "headache",
    "confusion",
    "dizziness",
    "sensitivity to light"
  ),

  vascular = c(
    "chest discomfort",
    "palpitations",
    "unusual bruising",
    "limb pain"
  ),

  dermatological = c(
    "rash",
    "skin mottling",
    "itching"
  )
)

# NEW: subtle weighting so patterns emerge statistically
profile_weights <- c(
  systemic = 0.35,
  gastrointestinal = 0.2,
  neurological = 0.2,
  vascular = 0.15,
  dermatological = 0.1
)

# Non-pandemic presentations remain simple red herrings
non_pandemic_symptoms <- c(
  "seasonal allergies",
  "migraine",
  "food poisoning",
  "bacterial pneumonia",
  "asthma exacerbation"
)

# ----------------------------------------------------------------
# Comorbidities
# ----------------------------------------------------------------

comorbidities <- c(
  "type II diabetes",
  "hypertension",
  "asthma",
  "COPD",
  "chronic kidney disease",
  "immunosuppressive therapy",
  "obesity",
  "none"
)

# ----------------------------------------------------------------
# Exposure histories
# ----------------------------------------------------------------

exposures <- c(
  "recent international travel",
  "healthcare worker",
  "lives in student accommodation",
  "attended large indoor event",
  "works from home",
  "care home resident",
  "no known exposure"
)

# ----------------------------------------------------------------
# Plausible ages per exposure
# ----------------------------------------------------------------

exposure_age_ranges <- list(
  "recent international travel" = 18:80,
  "healthcare worker" = 22:65,
  "lives in student accommodation" = 17:25,
  "attended large indoor event" = 16:70,
  "works from home" = 20:70,
  "care home resident" = 65:100,
  "no known exposure" = 0:100
)

# ----------------------------------------------------------------
# Outcomes
# ----------------------------------------------------------------

icu_beds <- 18
icu_count <- 0
ward_numbers <- 1:20

assign_outcome <- function() {

  probs <- c(ward = 0.7, icu = 0.1, outpatient = 0.2)

  if (icu_count >= icu_beds) {
    probs["icu"] <- 0
    probs <- probs / sum(probs)
  }

  outcome_type <- sample(names(probs), 1, prob = probs)

  if (outcome_type == "icu") {
    icu_count <<- icu_count + 1
    outcome <- "admitted (ICU)"
  } else if (outcome_type == "ward") {
    ward <- sample(ward_numbers, 1)
    outcome <- paste0("admitted (ward ", ward, ")")
  } else {
    outcome <- "outpatient care"
  }

  outcome
}

# ----------------------------------------------------------------
# Helper function
# ----------------------------------------------------------------

random_subset <- function(x, min_n = 1, max_n = 3) {
  sample(x, sample(min_n:max_n, 1))
}

# ============================================================
# Generate patient data
# ============================================================

generate_patient <- function(id) {

  name <- randomNames(1)

  # Pandemic case probability unchanged
  pandemic_case <- sample(c(TRUE, FALSE), 1, prob = c(0.75, 0.25))

  # ------------------------------------------------------------
  # CHANGED: syndrome-based symptom generation
  # ------------------------------------------------------------
  if (pandemic_case) {

    chosen_profiles <- sample(
      names(syndrome_profiles),
      sample(1:2, 1),
      prob = profile_weights
    )

    symptoms <- unlist(
      lapply(chosen_profiles, function(p)
        random_subset(syndrome_profiles[[p]], 1, 3))
    )

  } else {
    symptoms <- random_subset(non_pandemic_symptoms, 1, 2)
  }

  comorbidity <- sample(comorbidities, 1)
  exposure <- sample(exposures, 1)
  age <- sample(exposure_age_ranges[[exposure]], 1)

  admission_date <- workshop3_date - sample(0:5, 1)

  outcome <- assign_outcome()

  tibble(
    patient_id = paste0("P", sprintf("%03d", id)),
    name = name,
    age = age,
    admission_date = admission_date,
    pandemic_case = pandemic_case,
    symptoms = paste(unique(symptoms), collapse = "; "),
    comorbidity = comorbidity,
    exposure_history = exposure,
    outcome = outcome
  )
}

# Generate 100 patients
patients <- bind_rows(
  lapply(1:100, generate_patient)
)
```


### Patient Records {.unnumbered} 

Some of the most recent records from `r hosp_name` have been collated below.

```{r 940print}
#| echo: false
#| results: asis

for (i in 1:50) {

  p <- patients[i, ]

  cat(sprintf(
'::: {.callout-note collapse="true" icon=false}
## Patient Record: %s

**Patient ID:** %s  
**Age:** %s  
**Admission Date:** %s  
**Potential Exposure history:** %s  
**Symptoms:** %s  
**Possible Comorbidities/Previous Medical History:** %s  
**Outcome:** %s  

:::

',
    p$name,
    p$patient_id,
    p$age,
    p$admission_date,
    p$exposure_history,
    p$symptoms,
    p$comorbidity,
    p$outcome
  ))
}
```

### Potential pandemic death records

Some of the most recent death records identified as being potentially due to the pandemic in `r city_name` have been collated below: 

```{r}
#| label: death-certificates
#| include: false
# NEW: mechanism-based deaths (novel pathogen feel)
death_causes <- c(
  "systemic inflammatory syndrome",
  "multi-organ dysfunction",
  "acute metabolic collapse",
  "vascular complications",
  "unknown infectious cause"
)

generate_death_certificate <- function(id) {

  name <- randomNames(1)

  exposure <- sample(exposures, 1)
  age <- sample(exposure_age_ranges[[exposure]], 1)

  date_of_death <- workshop3_date - sample(0:5, 1)

  cause <- sample(death_causes, 1)
  comorbidity <- sample(comorbidities, 1)

  tibble(
    death_id = paste0("D", sprintf("%03d", id)),
    name = name,
    age = age,
    date_of_death = date_of_death,
    cause_of_death = cause,
    comorbidity = comorbidity
  )
}

death_certificates <- bind_rows(
  lapply(1:10, generate_death_certificate)
)
```

```{r 940printdeath}
#| echo: false
#| results: asis

for (i in 1:nrow(death_certificates)) {
  d <- death_certificates[i, ]
  
  cat(sprintf(
'::: {.callout-warning collapse="true" icon=false}
## **Death ID:** %s  
**Name:** %s  
**Age:** %s  
**Date of Death:** %s  
**Cause of Death:** %s  
**Comorbidities/Medical History:** %s  

:::

',
    d$death_id,
    d$name,
    d$age,
    d$date_of_death,
    d$cause_of_death,
    d$comorbidity
  ))
}

```


